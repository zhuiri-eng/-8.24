<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>蓝鲸支付测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .result.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .result.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .payment-info {
            margin-top: 15px;
        }
        .payment-info p {
            margin: 5px 0;
        }
        .qr-iframe {
            width: 200px;
            height: 200px;
            border: none;
        }
        .copy-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 10px;
        }
        .copy-btn:hover {
            background-color: #218838;
        }
        #qrCode {
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>蓝鲸支付测试</h1>
        <form id="paymentForm">
            <div class="form-group">
                <label for="amount">支付金额 (元):</label>
                <input type="number" id="amount" step="0.01" min="0.01" required>
            </div>
            
            <div class="form-group">
                <label for="description">商品描述:</label>
                <input type="text" id="description" required>
            </div>
            
            <div class="form-group">
                <label for="payType">支付方式:</label>
                <select id="payType">
                    <option value="1">微信支付</option>
                    <option value="2">支付宝支付</option>
                </select>
            </div>
            
            <button type="submit" id="submitBtn">立即支付</button>
        </form>
        
        <div id="result" class="result"></div>
        <div id="qrCode" style="display: none;">
            <div id="qrCodeContent"></div>
        </div>
    </div>

    <script>
        // 通讯密钥
        const appSecret = 'f659709e38ab01a9d77e52cdcda9a914';
        
        // 生成MD5签名
        function generateSign(payId, param, type, price) {
            const signStr = payId + param + type + price + appSecret;
            console.log('签名字符串:', signStr);
            
            // 使用内置的MD5实现
            return simpleMD5(signStr);
        }
        
        // 简单MD5实现（用于不支持Web Crypto API的环境）
        function simpleMD5(str) {
            // 这里使用一个简单的MD5实现
            // 实际应用中建议使用成熟的库如crypto-js
            function md5cycle(x, k) {
                var a = x[0], b = x[1], c = x[2], d = x[3];
                
                a = ff(a, b, c, d, k[0], 7, -680876936);
                d = ff(d, a, b, c, k[1], 12, -389564586);
                c = ff(c, d, a, b, k[2], 17,  606105819);
                b = ff(b, c, d, a, k[3], 22, -1044525330);
                a = ff(a, b, c, d, k[4], 7, -176418897);
                d = ff(d, a, b, c, k[5], 12,  1200080426);
                c = ff(c, d, a, b, k[6], 17, -1473231341);
                b = ff(b, c, d, a, k[7], 22, -45705983);
                a = ff(a, b, c, d, k[8], 7,  1770035416);
                d = ff(d, a, b, c, k[9], 12, -1958414417);
                c = ff(c, d, a, b, k[10], 17, -42063);
                b = ff(b, c, d, a, k[11], 22, -1990404162);
                a = ff(a, b, c, d, k[12], 7,  1804603682);
                d = ff(d, a, b, c, k[13], 12, -40341101);
                c = ff(c, d, a, b, k[14], 17, -1502002290);
                b = ff(b, c, d, a, k[15], 22,  1236535329);

                a = gg(a, b, c, d, k[1], 5, -165796510);
                d = gg(d, a, b, c, k[6], 9, -1069501632);
                c = gg(c, d, a, b, k[11], 14,  643717713);
                b = gg(b, c, d, a, k[0], 20, -373897302);
                a = gg(a, b, c, d, k[5], 5, -701558691);
                d = gg(d, a, b, c, k[10], 9,  38016083);
                c = gg(c, d, a, b, k[15], 14, -660478335);
                b = gg(b, c, d, a, k[4], 20, -405537848);
                a = gg(a, b, c, d, k[9], 5,  568446438);
                d = gg(d, a, b, c, k[14], 9, -1019803690);
                c = gg(c, d, a, b, k[3], 14, -187363961);
                b = gg(b, c, d, a, k[8], 20,  1163531501);
                a = gg(a, b, c, d, k[13], 5, -1444681467);
                d = gg(d, a, b, c, k[2], 9, -51403784);
                c = gg(c, d, a, b, k[7], 14,  1735328473);
                b = gg(b, c, d, a, k[12], 20, -1926607734);

                a = hh(a, b, c, d, k[5], 4, -378558);
                d = hh(d, a, b, c, k[8], 11, -2022574463);
                c = hh(c, d, a, b, k[11], 16,  1839030562);
                b = hh(b, c, d, a, k[14], 23, -35309556);
                a = hh(a, b, c, d, k[1], 4, -1530992060);
                d = hh(d, a, b, c, k[4], 11,  1272893353);
                c = hh(c, d, a, b, k[7], 16, -155497632);
                b = hh(b, c, d, a, k[10], 23, -1094730640);
                a = hh(a, b, c, d, k[13], 4,  681279174);
                d = hh(d, a, b, c, k[0], 11, -358537222);
                c = hh(c, d, a, b, k[3], 16, -722521979);
                b = hh(b, c, d, a, k[6], 23,  76029189);
                a = hh(a, b, c, d, k[9], 4, -640364487);
                d = hh(d, a, b, c, k[12], 11, -421815835);
                c = hh(c, d, a, b, k[15], 16,  530742520);
                b = hh(b, c, d, a, k[2], 23, -995338651);

                a = ii(a, b, c, d, k[0], 6, -198630844);
                d = ii(d, a, b, c, k[7], 10,  1126891415);
                c = ii(c, d, a, b, k[14], 15, -1416354905);
                b = ii(b, c, d, a, k[5], 21, -57434055);
                a = ii(a, b, c, d, k[12], 6,  1700485571);
                d = ii(d, a, b, c, k[3], 10, -1894986606);
                c = ii(c, d, a, b, k[10], 15, -1051523);
                b = ii(b, c, d, a, k[1], 21, -2054922799);
                a = ii(a, b, c, d, k[8], 6,  1873313359);
                d = ii(d, a, b, c, k[15], 10, -30611744);
                c = ii(c, d, a, b, k[6], 15, -1560198380);
                b = ii(b, c, d, a, k[13], 21,  1309151649);
                a = ii(a, b, c, d, k[4], 6, -145523070);
                d = ii(d, a, b, c, k[11], 10, -1120210379);
                c = ii(c, d, a, b, k[2], 15,  718787259);
                b = ii(b, c, d, a, k[9], 21, -343485551);

                x[0] = add32(a, x[0]);
                x[1] = add32(b, x[1]);
                x[2] = add32(c, x[2]);
                x[3] = add32(d, x[3]);
            }

            function cmn(q, a, b, x, s, t) {
                a = add32(add32(a, q), add32(x, t));
                return add32((a << s) | (a >>> (32 - s)), b);
            }

            function ff(a, b, c, d, x, s, t) {
                return cmn((b & c) | ((~b) & d), a, b, x, s, t);
            }

            function gg(a, b, c, d, x, s, t) {
                return cmn((b & d) | (c & (~d)), a, b, x, s, t);
            }

            function hh(a, b, c, d, x, s, t) {
                return cmn(b ^ c ^ d, a, b, x, s, t);
            }

            function ii(a, b, c, d, x, s, t) {
                return cmn(c ^ (b | (~d)), a, b, x, s, t);
            }

            function md5blk(s) {
                var md5blks = [], i;
                for (i = 0; i < 64; i += 4) {
                    md5blks[i >> 2] = s.charCodeAt(i) + (s.charCodeAt(i + 1) << 8) + (s.charCodeAt(i + 2) << 16) + (s.charCodeAt(i + 3) << 24);
                }
                return md5blks;
            }

            var hex_chr = '0123456789abcdef'.split('');

            function rhex(n) {
                var s = '', j = 0;
                for (; j < 4; j++)
                    s += hex_chr[(n >> (j * 8 + 4)) & 0x0F] + hex_chr[(n >> (j * 8)) & 0x0F];
                return s;
            }

            function hex(x) {
                for (var i = 0; i < x.length; i++)
                    x[i] = rhex(x[i]);
                return x.join('');
            }

            function md5(s) {
                return hex(md51(s));
            }

            function md51(s) {
                var n = s.length,
                    state = [1732584193, -271733879, -1732584194, 271733878], i;
                for (i = 64; i <= s.length; i += 64) {
                    md5cycle(state, md5blk(s.substring(i - 64, i)));
                }
                s = s.substring(i - 64);
                var tail = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                for (i = 0; i < s.length; i++)
                    tail[i >> 2] |= s.charCodeAt(i) << ((i % 4) << 3);
                tail[i >> 2] |= 0x80 << ((i % 4) << 3);
                if (i > 55) {
                    md5cycle(state, tail);
                    for (i = 0; i < 16; i++) tail[i] = 0;
                }
                tail[14] = n * 8;
                md5cycle(state, tail);
                return state;
            }

            function add32(a, b) {
                return (a + b) & 0xFFFFFFFF;
            }

            return md5(str);
        }
        
        // 发送支付请求
        function sendPaymentRequest(data) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', 'https://2277857.pay.lanjingzf.com/createOrder', true);
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            try {
                                const response = JSON.parse(xhr.responseText);
                                resolve(response);
                            } catch (e) {
                                reject(new Error('解析响应失败: ' + e.message));
                            }
                        } else {
                            reject(new Error('请求失败，状态码: ' + xhr.status));
                        }
                    }
                };
                
                // 转换数据为表单格式
                const formData = new URLSearchParams(data).toString();
                xhr.send(formData);
            });
        }
        
        document.getElementById('paymentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const resultDiv = document.getElementById('result');
            const qrCodeDiv = document.getElementById('qrCode');
            const qrCodeContent = document.getElementById('qrCodeContent');
            
            submitBtn.disabled = true;
            submitBtn.textContent = '处理中...';
            
            resultDiv.style.display = 'none';
            qrCodeDiv.style.display = 'none';
            
            try {
                // 获取表单数据
                const amount = parseFloat(document.getElementById('amount').value);
                const description = document.getElementById('description').value;
                const type = document.getElementById('payType').value;
                const payId = 'ORDER_' + Date.now(); // 生成订单号
                
                // 生成签名
                const sign = generateSign(payId, description, type, amount.toString());
                
                // 构建请求数据
                const requestData = {
                    payId: payId,
                    type: type,
                    price: amount.toString(),
                    sign: sign,
                    param: description,
                    isHtml: '1' // 自动跳转到支付页面
                };
                
                console.log('发送支付请求:', requestData);
                
                // 发送支付请求
                const result = await sendPaymentRequest(requestData);
                console.log('支付响应:', result);
                
                if (result.code === 1) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h3>✅ 支付订单创建成功</h3>
                        <div class="payment-info">
                            <h4>订单信息</h4>
                            <p><strong>商户订单号:</strong> ${result.data.payId}</p>
                            <p><strong>蓝鲸订单号:</strong> ${result.data.orderId}</p>
                            <p><strong>金额:</strong> ${result.data.reallyPrice} 元</p>
                            <p><strong>支付类型:</strong> ${result.data.payType === '1' ? '微信支付' : '支付宝支付'}</p>
                            <p><strong>状态:</strong> 等待支付</p>
                            <p><strong>超时时间:</strong> ${result.data.timeOut} 分钟</p>
                            <p><strong>支付链接:</strong> 
                                <a href="${result.data.payUrl}" target="_blank" style="color: #155724;">${result.data.payUrl}</a>
                                <button class="copy-btn" onclick="copyToClipboard('${result.data.payUrl}')">复制</button>
                            </p>
                        </div>
                    `;
                    
                    if (result.data.qrCodeUrl) {
                        qrCodeContent.innerHTML = `
                            <iframe src="${result.data.qrCodeUrl}" class="qr-iframe" title="支付二维码"></iframe>
                            <p><strong>请使用手机扫描二维码完成支付</strong></p>
                            <p><small>或者点击上方支付链接直接跳转</small></p>
                        `;
                        qrCodeDiv.style.display = 'block';
                    }
                    
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `
                        <h3>❌ 支付订单创建失败</h3>
                        <p><strong>错误码:</strong> ${result.code}</p>
                        <p><strong>错误信息:</strong> ${result.msg}</p>
                    `;
                }
                
            } catch (error) {
                console.error('支付请求异常:', error);
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<h3>❌ 系统异常</h3><p>${error.message}</p>`;
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '立即支付';
                resultDiv.style.display = 'block';
            }
        });
        
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            alert('支付链接已复制到剪贴板！');
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('蓝鲸支付测试页面加载完成');
        });
    </script>
</body>
</html>